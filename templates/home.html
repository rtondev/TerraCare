<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Denúncias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100">
    {% include 'components/navbar.html' %}

    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Mapa -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-4">
                <div id="map" class="h-[600px] rounded-lg"></div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="flex space-x-2">
                        <button onclick="showMyArea()" class="px-4 py-2 bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200">
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            Minha Área
                        </button>
                        <button onclick="showAllReports()" class="px-4 py-2 bg-purple-100 text-purple-800 rounded-md hover:bg-purple-200">
                            <i class="fas fa-globe mr-2"></i>
                            Todas as Denúncias
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista de Denúncias -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Denúncias Recentes</h2>
                    <a href="/report/new" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                        Nova Denúncia
                    </a>
                </div>
                
                <div class="space-y-4 max-h-[500px] overflow-y-auto">
                    {% for report in reports %}
                    <div class="border-b pb-4">
                        <div class="flex justify-between items-start">
                            <h3 class="font-semibold text-gray-800">{{ report.address }}</h3>
                            <span class="text-sm px-2 py-1 rounded-full 
                                {% if report.status == 'Pendente' %}bg-yellow-100 text-yellow-800
                                {% elif report.status == 'Em Análise' %}bg-blue-100 text-blue-800
                                {% elif report.status == 'Resolvido' %}bg-green-100 text-green-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ report.status }}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">{{ report.description[:100] }}...</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-gray-500">
                                {{ report.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </span>
                            <a href="/report/{{ report.id }}" class="text-blue-500 hover:text-blue-700 text-sm">
                                Ver detalhes
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        let userLat = {{ current_user.latitude or 'null' }};
        let userLng = {{ current_user.longitude or 'null' }};

        // Se não tiver localização do usuário, tenta obter
        if (!userLat || !userLng) {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLat = position.coords.latitude;
                    userLng = position.coords.longitude;
                    initMap();
                }, function(error) {
                    // Em caso de erro, usa localização padrão
                    userLat = -23.5505;
                    userLng = -46.6333;
                    initMap();
                });
            } else {
                userLat = -23.5505;
                userLng = -46.6333;
                initMap();
            }
        } else {
            initMap();
        }

        function initMap() {
            // Inicializar o mapa na localização do usuário
            const map = L.map('map').setView([userLat, userLng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Adicionar marcador do usuário
            L.marker([userLat, userLng], {
                icon: L.divIcon({
                    className: 'bg-blue-500 w-4 h-4 rounded-full border-2 border-white',
                    iconSize: [16, 16]
                })
            }).addTo(map).bindPopup('Sua localização');

            // Adicionar círculo ao redor da localização do usuário
            L.circle([userLat, userLng], {
                color: '#FFA500',
                fillColor: '#FFD700',
                fillOpacity: 0.1,
                radius: 1000  // raio em metros (1km)
            }).addTo(map);

            // Adicionar marcadores para cada denúncia
            {% for report in reports %}
            L.marker([{{ report.latitude }}, {{ report.longitude }}], {
                icon: L.divIcon({
                    className: 'bg-red-500 w-4 h-4 rounded-full border-2 border-white',
                    iconSize: [16, 16]
                })
            }).addTo(map)
            .bindPopup(`
                <div class="p-2">
                    <strong class="block mb-1">{{ report.address }}</strong>
                    <span class="inline-block px-2 py-1 text-xs rounded-full 
                        {% if report.status == 'Pendente' %}bg-yellow-100 text-yellow-800
                        {% elif report.status == 'Em Análise' %}bg-blue-100 text-blue-800
                        {% elif report.status == 'Resolvido' %}bg-green-100 text-green-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                        {{ report.status }}
                    </span>
                    <a href="/report/{{ report.id }}" class="block mt-2 text-blue-500 hover:text-blue-700">
                        Ver detalhes
                    </a>
                </div>
            `);

            // Adicionar polígono se houver pontos
            {% if report.polygon_points_list %}
            L.polygon({{ report.polygon_points_list|tojson }}, {
                color: '#FFA500',
                weight: 2,
                fillColor: '#FFD700',
                fillOpacity: 0.2
            }).addTo(map);
            {% endif %}
            {% endfor %}
        }

        // Função para mostrar apenas minha área
        function showMyArea() {
            map.setView([userLat, userLng], 14);
            cityCircle.setStyle({ opacity: 1, fillOpacity: 0.1 });
            
            markers.forEach(({marker}) => {
                const markerLatLng = marker.getLatLng();
                const distance = map.distance([userLat, userLng], [markerLatLng.lat, markerLatLng.lng]);
                
                if (distance <= 5000) { // 5km
                    marker.addTo(map);
                } else {
                    marker.remove();
                }
            });
        }

        // Função para mostrar todas as denúncias
        function showAllReports() {
            const bounds = L.latLngBounds(markers.map(m => m.marker.getLatLng()));
            map.fitBounds(bounds.pad(0.1));
            cityCircle.setStyle({ opacity: 0.3, fillOpacity: 0.05 });
            
            markers.forEach(({marker}) => {
                marker.addTo(map);
            });
        }

        // Inicializar mostrando minha área por padrão
        showMyArea();
    </script>
</body>
</html> 